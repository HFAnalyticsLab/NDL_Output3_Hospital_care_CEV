---
title: "Networked Data Lab, hospital use among CEV people during COVID-19"
author: "Sebastien Peytrignet"
date: "3/11/2021"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Load packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,stringr,sp,ggplot2,plyr,readODS,
               gmodels,DescTools,data.table,
               tibble,pbapply,pbmcapply,here,
               tidyverse,readxl,plotly,hrbrthemes,RColorBrewer,
               knitr,kableExtra)

rm(list = ls())

#Directories
# gitdir <- rstudioapi::getSourceEditorContext()$path %>%
#   dirname(.) %>%
#   dirname(.)
#setwd(gitdir)

rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 3 HC usage/"
gitdir <- "M:/Analytics/Sebastien/GitHub/NDL_Output3_Hospital_care_CEV/"

#Aux data
bl.orders <- data.frame(order=1:4,breakdown.level=c("outpatient_attendance","AE_attendance","admissions_electives","admissions_emergency"))
month.lookup <- data.frame(month.number=c("01","02","03","04","05","06","07","08","09","10","11","12"),
                           month.abbr=month.abb)

#Files directory
setwd(gitdir)

#Load partner data
table1.all.partners <- fread("Visualize data/Data/table1.all.partners.csv",
                             header=TRUE, sep=",", check.names=T) %>%
  left_join(.,bl.orders,by="breakdown.level")

table2.all.partners <- fread("Visualize data/Data/table2.all.partners.csv",
                             header=TRUE, sep=",", check.names=T)

table3.all.partners <- fread("Visualize data/Data/table3.all.partners.csv",
                             header=TRUE, sep=",", check.names=T)

#Changes data

table1.all.partners.pcts <-  table1.all.partners %>%
  filter(., !(breakdown.level %in% c("admissions_other","admissions_all"))) %>%
  filter(., !(strata %in% c("unknown","unknown/other"))) %>%
  select(.,partner,year_month,strata,breakdown,breakdown.level,number.events.sdc,total.patients) %>%
  mutate(.,year=word(year_month, 1, sep = fixed('-')),
         month=word(year_month, 2, sep = fixed('-'))) %>%
  mutate(.,year_month_day=lubridate::dmy(paste(15,month,year,sep="-")),
         year_l1=(as.numeric(year)-1)) %>%
  mutate(.,year_month_day_l1=lubridate::dmy(paste(15,month,year_l1,sep="-")),
         keyone=paste(partner,breakdown,strata,breakdown.level,sep="-"))

table1.all.partners.pcts.l1 <- table1.all.partners.pcts %>%
  select(.,keyone,year_month_day,number.events.sdc) %>%
  dplyr::rename(.,number.events.sdc_l1=number.events.sdc,
                year_month_day_l1=year_month_day)

table1.all.partners.pcts <- left_join(table1.all.partners.pcts,
                                      table1.all.partners.pcts.l1,
                                      by=c("keyone","year_month_day_l1")) %>%
  select(.,-c("keyone","year_l1")) %>%
  left_join(.,month.lookup,by=c("month"="month.number")) %>%
  mutate(.,pct_change_20to19=(number.events.sdc-number.events.sdc_l1)/number.events.sdc_l1*100,
         abs_change_12m=(number.events.sdc-number.events.sdc_l1),
         month.abbr.year=paste(month.abbr,substr(year, 3, 4),sep="")) %>%
  filter(.,year_month>="2019-07") %>%
  mutate(.,year_month_day=lubridate::ymd(year_month_day)) %>%
  arrange(.,partner,breakdown,strata,breakdown.level,year_month)
rm(table1.all.partners.pcts.l1)

#Color palettes for age
my_orange = brewer.pal(n = 9, "Oranges")[6:9]

#Function to clean column names
clean_colnames <- function(dataset){
  names(dataset) <- str_replace_all(names(dataset),"\\.","_")
  return(dataset)
}
```

<!-- ## Activity levels in January 2020 -->

<!-- ### Pooled -->

<!-- ```{r jan.levels.pooled, echo=FALSE, message=FALSE, warning=FALSE} -->

<!-- detach(package:plyr) -->
<!-- jan20_table_pooled <- filter(table1.all.partners, year_month=="2020-01", -->
<!--        breakdown.level!="admissions_all",breakdown.level!="admissions_other", -->
<!--        strata=="overall") %>% -->
<!--   group_by(year_month,breakdown.level) %>% -->
<!--   summarise(number.events.sdc=sum(number.events.sdc,na.rm=TRUE), -->
<!--             total.patients=sum(total.patients,na.rm=TRUE)) %>% -->
<!--   ungroup() %>% -->
<!--   mutate(.,cases.per.person=number.events.sdc/total.patients, -->
<!--          cases.per.100=number.events.sdc/total.patients*100) %>% -->
<!--   mutate(.,inv_cases.per.person=1/cases.per.person) %>% -->
<!--   select(.,year_month,breakdown.level, -->
<!--          cases.per.100,cases.per.person,inv_cases.per.person) %>% -->
<!--   clean_colnames(.) -->

<!-- jan20_table_pooled %>% -->
<!--   kable(.,digits=1,format.args = list(big.mark = ",")) %>% -->
<!--   kable_styling() -->

<!-- ``` -->

<!-- ### By partner -->

<!-- Contacts per person, contacts per 100 people, people per 1 contact -->

<!-- ```{r jan.levels, echo=FALSE, message=FALSE, warning=FALSE} -->

<!-- jan20_table <- filter(table1.all.partners, year_month=="2020-01", -->
<!--        breakdown.level!="admissions_all",strata=="overall") %>% -->
<!--   mutate(.,cases.per.person=cases.per.100/100) %>% -->
<!--   mutate(.,inv_cases.per.person=1/cases.per.person) %>% -->
<!--   select(.,partner,year_month,breakdown.level, -->
<!--          cases.per.100,cases.per.person,inv_cases.per.person) %>% -->
<!--   arrange(.,breakdown.level,year_month,cases.per.person) %>% -->
<!--   clean_colnames(.) -->

<!-- jan20_table %>%  -->
<!--   kable(.,digits=1,format.args = list(big.mark = ",")) %>% -->
<!--   kable_styling(bootstrap_options = c("striped", "hover"),full_width = F, font_size= 8) -->
<!-- ``` -->

## % reduction in activity in April 2020 vs. April 2019 (A&E and outpatient)

### Pooled (all 5 partners)

```{r apr.pct.change.pooled, echo=FALSE, message=FALSE, warning=FALSE}

pooled.drop.april <- filter(table1.all.partners.pcts,strata=="overall",
                            year_month=="2020-04",
                            breakdown.level %in% c("outpatient_attendance",
                                                   "AE_attendance")) %>%
  select(.,breakdown.level,partner,year_month,
         number.events.sdc_l1,number.events.sdc,
         abs_change_12m) %>%
  group_by(breakdown.level) %>%
  summarise(.,number.events.sdc_l1=sum(number.events.sdc_l1,na.rm=TRUE),
            abs_change_12m=sum(abs_change_12m,na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(.,pct_change=abs_change_12m/number.events.sdc_l1*100) %>%
  select(.,breakdown.level,abs_change_12m,pct_change) %>%
  clean_colnames(.)

pooled.drop.april %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling()
```

### By partner

```{r apr.pct.change, echo=FALSE, message=FALSE, warning=FALSE}

drop.april <- filter(table1.all.partners.pcts,strata=="overall",
                            year_month=="2020-04",
                            breakdown.level %in% c("outpatient_attendance",
                                                   "AE_attendance")) %>%
  select(.,breakdown.level,partner,year_month,
         number.events.sdc_l1,number.events.sdc,abs_change_12m) %>%
  group_by(breakdown.level,partner) %>%
  summarise(.,number.events.sdc_l1=sum(number.events.sdc_l1,na.rm=TRUE),
            abs_change_12m=sum(abs_change_12m,na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(.,pct_change=abs_change_12m/number.events.sdc_l1*100) %>%
  select(.,breakdown.level,partner,abs_change_12m,pct_change) %>%
  arrange(.,breakdown.level,desc(pct_change)) %>%
  clean_colnames(.)

drop.april %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(., full_width = F, font_size= 8)
```

## % reduction in activity in April 2020 vs. April 2019 (elective admissions)

### Pooled (excl. Leeds)

```{r elective.apr.pct.change.pooled, echo=FALSE, message=FALSE, warning=FALSE}

pooled.drop.april <- filter(table1.all.partners.pcts,strata=="overall",
                            year_month=="2020-04",partner!="Leeds",
                            breakdown.level %in% c("admissions_electives")) %>%
  select(.,breakdown.level,partner,year_month,
         number.events.sdc_l1,number.events.sdc,
         abs_change_12m) %>%
  group_by(breakdown.level) %>%
  summarise(.,number.events.sdc_l1=sum(number.events.sdc_l1,na.rm=TRUE),
            abs_change_12m=sum(abs_change_12m,na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(.,pct_change=abs_change_12m/number.events.sdc_l1*100) %>%
  select(.,breakdown.level,abs_change_12m,pct_change) %>%
  clean_colnames(.)

pooled.drop.april %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling()
```

### By partner

```{r elective.apr.pct.change, echo=FALSE, message=FALSE, warning=FALSE}

drop.april.bis <- filter(table1.all.partners.pcts,strata=="overall",
                            year_month=="2020-04",
                            breakdown.level %in% c("admissions_electives")) %>%
  select(.,breakdown.level,partner,year_month,
         number.events.sdc_l1,number.events.sdc,abs_change_12m) %>%
  group_by(breakdown.level,partner) %>%
  summarise(.,number.events.sdc_l1=sum(number.events.sdc_l1,na.rm=TRUE),
            abs_change_12m=sum(abs_change_12m,na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(.,pct_change=abs_change_12m/number.events.sdc_l1*100) %>%
  select(.,breakdown.level,partner,abs_change_12m,pct_change) %>%
  arrange(.,breakdown.level,desc(pct_change)) %>%
  clean_colnames(.)

drop.april.bis %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(., full_width = F, font_size= 8)
```

##  % reduction in activity in April 2020 vs. April 2019 (emergency admissions)

### Pooled (excl. Grampian and Leeds)

```{r emergency.pooled.apr.pct.change, echo=FALSE, message=FALSE, warning=FALSE}

drop.april.pooled.ng <- filter(table1.all.partners.pcts,strata=="overall",
                            year_month=="2020-04",partner!="Grampian",partner!="Leeds",
                            breakdown.level %in% c("admissions_emergency")) %>%
  select(.,breakdown.level,partner,year_month,
         number.events.sdc_l1,number.events.sdc,
         abs_change_12m) %>%
  group_by(breakdown.level) %>%
  summarise(.,number.events.sdc_l1=sum(number.events.sdc_l1,na.rm=TRUE),
            abs_change_12m=sum(abs_change_12m,na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(.,pct_change=abs_change_12m/number.events.sdc_l1*100) %>%
  select(.,breakdown.level,abs_change_12m,pct_change) %>%
  arrange(.,breakdown.level,desc(pct_change)) %>%
  clean_colnames(.)

drop.april.pooled.ng %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(., full_width = F)
```

### By partner

```{r emergency.apr.pct.change, echo=FALSE, message=FALSE, warning=FALSE}

drop.april.ae <- filter(table1.all.partners.pcts,strata=="overall",
                            year_month=="2020-04",
                            breakdown.level %in% c("admissions_emergency")) %>%
  select(.,breakdown.level,partner,year_month,
         number.events.sdc_l1,number.events.sdc,
         abs_change_12m) %>%
  group_by(breakdown.level,partner) %>%
  summarise(.,number.events.sdc_l1=sum(number.events.sdc_l1,na.rm=TRUE),
            abs_change_12m=sum(abs_change_12m,na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(.,pct_change=abs_change_12m/number.events.sdc_l1*100) %>%
  select(.,breakdown.level,partner,abs_change_12m,pct_change) %>%
  arrange(.,breakdown.level,desc(pct_change)) %>%
  clean_colnames(.)

drop.april.ae %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(., full_width = F)
```

## Jan to April 2020 % change in Grampian

```{r grampian.pct.change, echo=FALSE, message=FALSE, warning=FALSE}

grampian.emergency <- filter(table1.all.partners.pcts,strata=="overall",
       partner=="Grampian",
       breakdown.level %in% c("admissions_emergency"))

before <- filter(grampian.emergency,year_month=="2020-01")$number.events.sdc
after <- filter(grampian.emergency,year_month=="2020-04")$number.events.sdc
pct_change <- round((after-before)/before*100,1)

pct_change
```

## Change in absolute numbers March-July (2020 compared to 2019, excl. Leeds)

```{r march.july.change, echo=FALSE, message=FALSE, warning=FALSE}

table.abs.changes <- filter(table1.all.partners.pcts,strata=="overall",
                            year_month>="2020-03",partner!="Leeds",) %>%
  select(.,partner,year_month,breakdown.level,abs_change_12m) %>%
  arrange(.,partner,breakdown.level,year_month) %>%
  group_by(breakdown.level) %>%
  summarise(abs_change_12m=sum(abs_change_12m)) %>%
  ungroup() %>%
  clean_colnames(.)

total.patients <- filter(table1.all.partners,strata=="overall",
                         year_month>="2020-07",partner!="Leeds",
                         breakdown.level=="admissions_all") %>%
  select(.,total.patients) %>%
  sum(.)

table.abs.changes$total_patients <- total.patients

table.abs.changes %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(., full_width = F)
```

## % reduction in activity in April 2020 vs. April 2019, by age group and type of healthcare

### Pooled

```{r apr.drop.by.age.pooled, echo=FALSE, message=FALSE, warning=FALSE}
pooled.drop.april.by.age <- filter(table1.all.partners.pcts,breakdown=="age",
                            year_month=="2020-04",
                            breakdown.level %in% c("outpatient_attendance",
                                                   "AE_attendance"),
                            strata %in% c("0-29","70+")) %>%
  select(.,partner,strata,breakdown.level,year_month,
         number.events.sdc_l1,number.events.sdc,
         abs_change_12m) %>%
  group_by(breakdown.level,strata) %>%
  summarise(.,number.events.sdc_l1=sum(number.events.sdc_l1,na.rm=TRUE),
            abs_change_12m=sum(abs_change_12m,na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(.,pct_change=abs_change_12m/number.events.sdc_l1*100) %>%
  select(.,breakdown.level,strata,abs_change_12m,pct_change) %>%
  clean_colnames(.)

pooled.drop.april.by.age %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(.,bootstrap_options = c("striped", "hover"),full_width = F, font_size= 8)
```

### Pooled (excl. Leeds)

```{r apr.drop.by.age.pooled.ng, echo=FALSE, message=FALSE, warning=FALSE}
pooled.nl.drop.april.by.age <- filter(table1.all.partners.pcts,breakdown=="age",
                            year_month=="2020-04",partner!="Leeds",
                            breakdown.level %in% c("admissions_electives","admissions_emergency"),
                            strata %in% c("0-29","70+")) %>%
  select(.,partner,strata,breakdown.level,year_month,
         number.events.sdc_l1,number.events.sdc,
         abs_change_12m) %>%
  group_by(breakdown.level,strata) %>%
  summarise(.,number.events.sdc_l1=sum(number.events.sdc_l1,na.rm=TRUE),
            abs_change_12m=sum(abs_change_12m,na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(.,pct_change=abs_change_12m/number.events.sdc_l1*100) %>%
  select(.,breakdown.level,strata,abs_change_12m,pct_change) %>%
  clean_colnames(.)

pooled.nl.drop.april.by.age %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(.,bootstrap_options = c("striped", "hover"),full_width = F, font_size= 8)
```

### Pooled (excl. Grampian and Leeds)

```{r apr.drop.by.age.pooled.ngnl, echo=FALSE, message=FALSE, warning=FALSE}
pooled.ngnl.drop.april.by.age <- filter(table1.all.partners.pcts,breakdown=="age",
                            year_month=="2020-04",partner!="Grampian",partner!="Leeds",
                            breakdown.level %in% c("admissions_emergency"),
                            strata %in% c("0-29","70+")) %>%
  select(.,partner,strata,breakdown.level,year_month,
         number.events.sdc_l1,number.events.sdc,
         abs_change_12m) %>%
  group_by(breakdown.level,strata) %>%
  summarise(.,number.events.sdc_l1=sum(number.events.sdc_l1,na.rm=TRUE),
            abs_change_12m=sum(abs_change_12m,na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(.,pct_change=abs_change_12m/number.events.sdc_l1*100) %>%
  select(.,breakdown.level,strata,abs_change_12m,pct_change) %>%
  clean_colnames(.)

pooled.ngnl.drop.april.by.age %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(.,bootstrap_options = c("striped", "hover"),full_width = F, font_size= 8)
```

### By partner

```{r apr.drop.by.age, echo=FALSE, message=FALSE, warning=FALSE}
drop.april.by.age <- filter(table1.all.partners.pcts,breakdown=="age",
                            year_month=="2020-04",
                            breakdown.level %in% c("admissions_electives",
                                                   "outpatient_attendance",
                                                   "admissions_emergency",
                                                   "AE_attendance"),
                            strata %in% c("0-29","70+")) %>%
  select(.,partner,strata,breakdown.level,year_month,
         number.events.sdc_l1,number.events.sdc,
         abs_change_12m) %>%
  group_by(partner,breakdown.level,strata) %>%
  summarise(.,number.events.sdc_l1=sum(number.events.sdc_l1,na.rm=TRUE),
            abs_change_12m=sum(abs_change_12m,na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(.,pct_change=abs_change_12m/number.events.sdc_l1*100) %>%
  select(.,breakdown.level,strata,partner,abs_change_12m,pct_change) %>%
  arrange(.,breakdown.level,strata,desc(pct_change),) %>%
  clean_colnames(.)

drop.april.by.age %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(.,bootstrap_options = c("striped", "hover"),full_width = F, font_size= 8)
```


## Change in absolute numbers by age group (March to July 2020, compared to same period in 2019), excl. Leeds

```{r march.july.age.change, echo=FALSE, message=FALSE, warning=FALSE}

absolute_reduction_over_70 <- filter(table1.all.partners.pcts,breakdown=="age",
                                     breakdown.level %in% c("outpatient_attendance","admissions_electives"),
                                     strata %in% c("0-29","70+"),
                                     year_month>="2020-03",
                                     partner!="Leeds") %>%
  select(.,breakdown.level,partner,year_month,strata,total.patients,abs_change_12m) %>%
  group_by(breakdown.level,strata) %>%
  summarise(abs_difference=sum(abs_change_12m)) %>%
  ungroup() %>%
  clean_colnames(.)

absolute_reduction_over_70 %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(., full_width = F)

```

## Number of CEV people by age group (excl. Leeds)

```{r cohort.size.age, echo=FALSE, message=FALSE, warning=FALSE}
NDL_CEV_size <- filter(table1.all.partners,breakdown=="age",strata!="unknown",
                       breakdown.level %in% c("admissions_all"),
                       year_month=="2018-03",partner!="Leeds") %>%
  select(.,partner,breakdown.level,strata,total.patients) %>%
  group_by(.,breakdown.level,strata) %>%
  summarise(total.patients=sum(total.patients)) %>%
  ungroup() %>%
  clean_colnames(.)

NDL_CEV_size %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(., full_width = F)
```

## % of admissions that were COVID-related

### Pooled (excl. Leeds)

```{r pct.covid.pooled, echo=FALSE, message=FALSE, warning=FALSE}

covid.adm.data <- filter(table1.all.partners,strata=="overall",
                        breakdown.level=="admissions_all",
                        year_month>="2020-03",partner!="Leeds") %>%
  select(.,breakdown.level,partner,year_month,number.patients.sdc,number.patients.covid,total.patients)

#Rate of admitted patients who 'had COVID' (pooled)
pooled.covid  <- covid.adm.data %>%
  summarise(across(c("number.patients.sdc", "number.patients.covid"), ~ sum(.x, na.rm = TRUE))) %>%
  mutate(.,rate_adm_covid=number.patients.covid/number.patients.sdc*100) %>%
  clean_colnames(.)

pooled.covid %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(., full_width = F)

```

### By partner

```{r pct.covid.partners, echo=FALSE, message=FALSE, warning=FALSE}

covid.adm.data <- filter(table1.all.partners,strata=="overall",
                        breakdown.level=="admissions_all",
                        year_month>="2020-03") %>%
  select(.,breakdown.level,partner,year_month,number.patients.sdc,number.patients.covid,total.patients)

#Rate of admitted patients who 'had COVID' (unpooled)
allp.covid <- covid.adm.data %>%
  group_by(partner) %>%
  summarise(across(c("number.patients.sdc", "number.patients.covid"), ~ sum(.x, na.rm = TRUE))) %>%
  mutate(.,rate_adm_covid=number.patients.covid/number.patients.sdc*100) %>%
  ungroup() %>%
  arrange(.,rate_adm_covid) %>%
  clean_colnames(.)

allp.covid %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(., full_width = F)

```

## Total number of patients with COVID (excl. Leeds)

```{r total.covid, echo=FALSE, message=FALSE, warning=FALSE}

total.covid.patients <- filter(table1.all.partners,strata=="overall",
                         breakdown.level=="admissions_all",
                         year_month>="2020-03",partner!="Leeds") %>%
  select(.,breakdown.level,partner,year_month,number.patients.sdc,
         number.patients.covid,total.patients) %>%
  group_by(breakdown.level) %>%
  summarise(.,number.patients.covid=sum(number.patients.covid,na.rm=TRUE)) %>%
  ungroup() %>%
  clean_colnames(.)

total.covid.patients %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(., full_width = F)

```

## Total number of deaths

```{r total.deaths, echo=FALSE, message=FALSE, warning=FALSE}

total.deaths <- filter(table3.all.partners,location=="anywhere",
                       breakdown.level=="overall") %>%
  select(.,number.patients.sdc) %>%
  summarise(total.deaths=sum(number.patients.sdc,na.rm=TRUE)) %>%
  clean_colnames(.)

total.deaths %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(., full_width = F)

```

## Cumulative mortality rate

### Pooled

```{r pooled.cum.deaths, echo=FALSE, message=FALSE, warning=FALSE}

total.deaths.cum.pooled <- filter(table3.all.partners,
                                  location=="anywhere",
                                  breakdown.level=="overall") %>%
  select(.,location,year_month,partner,number.patients.sdc,total.patients) %>%
  group_by(partner) %>%
  summarise(.,number.patients.sdc=sum(number.patients.sdc,na.rm=TRUE),
            total.patients=first(total.patients)) %>%
  ungroup() %>%
  summarise(.,number.patients.sdc=sum(number.patients.sdc,na.rm=TRUE),
            total.patients=sum(total.patients,na.rm=TRUE)) %>%
  mutate(.,cum_rate=number.patients.sdc/total.patients*100) %>%
  clean_colnames(.)

total.deaths.cum.pooled %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(., full_width = F)

```

### All partners

```{r cum.deaths, echo=FALSE, message=FALSE, warning=FALSE}

total.deaths.cum <- filter(table3.all.partners,
                           year_month=="2020-07",
                           location=="anywhere",
                           breakdown.level=="overall") %>%
  select(.,partner,death_cum_pct) %>%
  arrange(.,death_cum_pct) %>%
  clean_colnames(.)

total.deaths.cum %>%
  kable(.,digits=1,format.args = list(big.mark = ",")) %>%
  kable_styling(., full_width = F)

```
